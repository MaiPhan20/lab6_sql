

CREATE DATABASE QLDH
--
CREATE TABLE KHACHHANG
(
	MaKhachhang INT
	CONSTRAINT PK_KHACHHANG_MaKhachHang PRIMARY KEY,
	TenKhachHang NVARCHAR(30),
	DiaChi NVARCHAR(20),
	Email VARCHAR (50),
	DienThoai	VARCHAR(15),
	Fax VARCHAR(15),
)
CREATE TABLE LOAIHANG
(
	MaLoaiHang	CHAR(4)
	CONSTRAINT PK_LOAIHANG_MaLoaiHang PRIMARY KEY(MaLoaiHang),
	TenLoaiHang NVARCHAR(30),
)
CREATE TABLE MATHANG
(
	MaHang CHAR(4)
	CONSTRAINT PK_MATHANG_MaHang PRIMARY KEY(MaHang),
	TenHang NVARCHAR(30),
	MaLoaiHang CHAR(4),
	SOLUONG INT,
	DonViTinh NVARCHAR(10),
	GiaHang	NUMERIC(10,2),
	MoTa NVARCHAR(30)
	CONSTRAINT FK_LOAIHANG_MATHANG FOREIGN KEY (MaLoaiHang) REFERENCES LOAIHANG(MaLoaiHang)
    )
	CREATE TABLE DONDATHANG
	(
	SoHoaDon INT
	CONSTRAINT PK_DONDATHANG_SoHoaDon PRIMARY KEY,
	MaKhachHang INT,
	NgayDatHang	DATETIME,
	NgayGiaohang	DATETIME,
	NgayChuyenHang	DATETIME,
	NoiGiaohang NVARCHAR(80),
	CONSTRAINT FK_DONDATHANG_MaKhachHang FOREIGN KEY(MaKhachHang) REFERENCES KHACHHANG(MaKhachHang)
	)
	CREATE TABLE CHITIETDATHANG
	(
	SoHoaDon	INT ,
	MaHang	CHAR(4),
	GiaBan	NUMERIC(10,2),
	SoLuong	INT,
	MucGiamGia	NUMERIC(10,2),
	CONSTRAINT PK_CHITIETDATHANG_SoHoaDon_MaHang PRIMARY KEY(SoHoaDon),
	CONSTRAINT FK_CHITIETDATHANG_SoHoaDon FOREIGN KEY (SoHoaDon)
	REFERENCES DONDATHANG(SoHoaDon),
	CONSTRAINT FK_CHITIETDATHANG_MaHang FOREIGN KEY(MaHang) REFERENCES MATHANG(MaHang)
	)
	--Bảng Loại Hàng dùng để phân loại các mặt hàng hiện có
	INSERT INTO LOAIHANG VALUES('MT01',N'Máy Tính')
	INSERT INTO LOAIHANG VALUES('DT01',N'Điện Thoại')
	INSERT INTO LOAIHANG VALUES('MI01',N'Máy In')
	--Bảng Khách Hàng
	select* from KHACHHANG
	INSERT INTO KHACHHANG VALUES('01',N'Mai Văn Phán',N'Hà Nội','hungviettien@gmail.com','09725435','02-463738')
	INSERT INTO KHACHHANG VALUES('02',N'Nguyễn VâN',N'Nam Định','phanvanmai@gmail.com','0973425','02-673633')
	INSERT INTO KHACHHANG VALUES('03',N'Vũ Anh Tuấn',N'Thái Bình','levanpham@gmail.com','08325435','02-463438')
	INSERT INTO KHACHHANG VALUES('123',N'Nguyễn Văn An',N' 111 Nguyễn Trãi','anlenuyen@gmail.com','987654321','02-464238')

	--Bảng Mặt Hàng
	INSERT INTO MATHANG VALUES('MH01',N'Máy Tính T450','MT01','1',N'Chiếc',1000,N'Máy nhập mơi')
	INSERT INTO MATHANG VALUES('MH02',N'Điện Thoại Nokia 5670','DT01','2',N'Chiếc',200,N'Điện thoại đang hot')
	INSERT INTO MATHANG VALUES('MH03',N'Máy in Samsung 450','MI01','1',N'Chiếc',100,N'Máy in đang ế')
	--Bảng đơn đặt hàng
	INSERT INTO DONDATHANG VALUES(001,'01','2018-5-6','2018-6-7','2018-7-8',N'Hà Nội')
	INSERT INTO DONDATHANG VALUES(002,'02','2018-4-5','2018-5-6','2018-6-7',N'Nam Định')
	INSERT INTO DONDATHANG VALUES(003,'03','2017-5-6','2017-6-7','2017-7-8',N'Thái Bình')
	INSERT INTO DONDATHANG VALUES(004,'123','2009-11-18','2017-6-7','2017-7-8',N'Thái Bình')

	--Bảng chi tiết đơn hàng
	INSERT INTO CHITIETDATHANG VALUES(001,'MH01',1000,'1',0)
	INSERT INTO CHITIETDATHANG VALUES(002,'MH02',200,'2',0)
	INSERT INTO CHITIETDATHANG VALUES(003,'MH03',100,'1',0)
	INSERT INTO CHITIETDATHANG VALUES(004,'MH02',100,'2',0)

	--4
	--a
	SELECT * FROM KHACHHANG
	--b
	SELECT * FROM MATHANG
	--C
	SELECT * FROM DONDATHANG
	--5
	--a
	SELECT * FROM KHACHHANG ORDER BY TenKhachHang ASC
	--b
	 SELECT * FROM MATHANG
	 ORDER BY SOLUONG DESC;
	--C
	SELECT DISTINCT S.MaHang, TenHang
	FROM MATHANG S INNER JOIN CHITIETDATHANG C
	ON S.MaHang = C.MaHang
	AND EXISTS(SELECT *
	FROM CHITIETDATHANG C INNER JOIN DONDATHANG H
	ON C.SoHoaDon = H.SoHoaDon
	and MaKhachHang IN(SELECT H.MaKhachHang
	FROM DONDATHANG H INNER JOIN KHACHHANG K
	ON H.MaKhachHang = K.MaKhachhang
	WHERE TenKhachHang = N'Nguyễn Văn An') AND S.MaHang = C.MaHang)
	--6
	--a
	SELECT K.MaKhachhang
	FROM KHACHHANG K INNER JOIN DONDATHANG H
	ON K.MaKhachhang = H.MaKhachHang
	--b
	SELECT  DISTINCT Mahang,TenHang
	FROM MATHANG
	--c
	SELECT DONDATHANG.MaKhachHang,CHITIETDATHANG.SoHoaDon,
	SUM(SOLUONG*GiaBan) as 'Thanh Tien'
	FROM CHITIETDATHANG,DONDATHANG
	WHERE DONDATHANG.SoHoaDon=CHITIETDATHANG.SoHoaDon
	GROUP BY MaKhachHang,CHITIETDATHANG.SoHoaDon
	--7
	--A
	UPDATE MATHANG SET MaLoaiHang = 'MT01' , GiaHang = 100000;
	SELECT * FROM MATHANG
	--B
	--C
	ALTER TABLE MATHANG
	ADD NgayXuatHien date;
	select * from MATHANG

